@page "/catalogo"
@rendermode InteractiveServer

@using FeriaAgricolaApp.Application.Controllers
@using FeriaAgricolaApp.Domain
@inject CatalogoController CatalogoController
@inject DireccionService DireccionService
@inject AppState State

<h3>Catálogo de Productos</h3>

@if (State.UsuarioActual == null)
{
    <p>Debe iniciar sesión.</p>
}
else
{
    <!-- ================= FERIAS ================= -->
    <div class="mb-3">
        <label class="form-label">Feria</label>
        <select class="form-select"
                value="@feriaSeleccionadaId"
                @onchange="FeriasChanged">
            <option value="0">-- Seleccione una feria --</option>
            @foreach (var f in ferias)
            {
                <option value="@f.Id">@f.Nombre</option>
            }
        </select>
    </div>

    <!-- ================= PROVEEDORES ================= -->
    <div class="mb-3">
        <label class="form-label">Proveedor</label>
        <select class="form-select"
                value="@proveedorSeleccionadoId"
                @onchange="ProveedoresChanged">
            @foreach (var p in proveedores)
            {
                <option value="@p.Id">@p.Nombre</option>
            }
        </select>
    </div>

    <!-- ================= BUSCAR ================= -->
    <div class="mb-3">
        <label class="form-label">Buscar producto</label>
        <input class="form-control"
               placeholder="Nombre del producto"
               @bind="textoBusqueda" />
        <button class="btn btn-secondary mt-2"
                @onclick="BuscarProductos">
            Buscar
        </button>
    </div>

    <!-- ================= PRODUCTOS ================= -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Proveedor</th>
                <th>Precio</th>
                <th>Unidad</th>
                <th>Stock</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in productos)
            {
                <tr>
                    <td>@p.Nombre</td>
                    <td>@NombreProveedor(p.ProveedorId)</td>
                    <td>₡@p.Precio</td>
                    <td>@p.UnidadMedida</td>
                    <td>@p.Stock</td>
                    <td>
                        <button class="btn btn-sm btn-primary"
                                disabled="@(p.Stock <= 0)"
                                @onclick="() => AgregarAlCarrito(p)">
                            Agregar
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code
{
    // ================= ESTADO =================
    private List<Feria> ferias = new();
    private List<Proveedor> proveedores = new();
    private List<Producto> productos = new();

    private int feriaSeleccionadaId;
    private int proveedorSeleccionadoId;
    private string textoBusqueda = string.Empty;

    // ================= INIT (equivale a Form_Load) =================
    protected override void OnInitialized()
    {
        if (State.UsuarioActual == null)
            return;

        CargarFerias();
    }

    // ================= FERIAS =================
    private void CargarFerias()
    {
        var direcciones = DireccionService.ObtenerPorUsuario(State.UsuarioActual!.Id);

        if (!direcciones.Any())
        {
            ferias = CatalogoController.ObtenerFerias();
        }
        else
        {
            var principal = direcciones.FirstOrDefault(d => d.EsPrincipal)
                            ?? direcciones.First();

            ferias = CatalogoController
                .ObtenerFeriasPorProvincia(principal.Provincia?.Trim() ?? "");
        }

        if (ferias.Any())
        {
            feriaSeleccionadaId = ferias[0].Id;
            CargarProveedoresPorFeria(feriaSeleccionadaId);
            CargarProductosPorFeria(feriaSeleccionadaId);
        }
    }

    private void FeriasChanged(ChangeEventArgs e)
    {
        feriaSeleccionadaId = int.TryParse(e.Value?.ToString(), out var id) ? id : 0;

        if (feriaSeleccionadaId <= 0)
        {
            proveedores.Clear();
            productos.Clear();
            proveedorSeleccionadoId = 0;
            StateHasChanged();
            return;
        }

        // Cargar proveedores (con "Todos")
        proveedores = CatalogoController.ObtenerProveedoresPorFeria(feriaSeleccionadaId) ?? new List<Proveedor>();
        proveedores.Insert(0, new Proveedor { Id = 0, Nombre = "Todos los proveedores" });
        proveedorSeleccionadoId = 0;

        // Cargar productos de la feria
        productos = CatalogoController.ObtenerProductosPorFeria(feriaSeleccionadaId) ?? new List<Producto>();

        StateHasChanged();
    }

    // ================= PROVEEDORES =================
    private void CargarProveedoresPorFeria(int feriaId)
    {
        proveedores = CatalogoController.ObtenerProveedoresPorFeria(feriaId);

        proveedores.Insert(0, new Proveedor
        {
            Id = 0,
            Nombre = "Todos los proveedores"
        });

        proveedorSeleccionadoId = 0;
    }

    private void ProveedoresChanged(ChangeEventArgs e)
    {
        proveedorSeleccionadoId = int.TryParse(e.Value?.ToString(), out var id) ? id : 0;

        if (proveedorSeleccionadoId == 0)
        {
            productos = CatalogoController.ObtenerProductosPorFeria(feriaSeleccionadaId) ?? new List<Producto>();
        }
        else
        {
            productos = CatalogoController.ObtenerProductosPorProveedor(proveedorSeleccionadoId) ?? new List<Producto>();
        }

        StateHasChanged();
    }

    // ================= PRODUCTOS =================
    private void CargarProductosPorFeria(int feriaId)
    {
        productos = CatalogoController.ObtenerProductosPorFeria(feriaId);
    }

    private void BuscarProductos()
    {
        if (string.IsNullOrWhiteSpace(textoBusqueda))
        {
            CargarProductosPorFeria(feriaSeleccionadaId);
            return;
        }

        productos = CatalogoController
            .BuscarProductosPorNombre(textoBusqueda, feriaSeleccionadaId);
    }

    // ================= CARRITO =================
    private void AgregarAlCarrito(Producto producto)
    {
        CatalogoController.AgregarAlCarrito(
            State.UsuarioActual!.Id,
            producto.Id
        );

        // Igual que WinForms
        Console.WriteLine("Producto agregado al carrito");
    }

    private string NombreProveedor(int proveedorId)
    {
        return proveedores.FirstOrDefault(p => p.Id == proveedorId)?.Nombre ?? "N/D";
    }
}
